---
title: "Write Yaml List from All Posts"
output: html_document
---

First, load some libraries that we'll need to write the YAML

```{r}
### This code reads through a set of files and parses out the YAML tags
### It then builds a yml list
### holy sweet awesomeness batman!
library(readr)
library(yaml)
library(dplyr)

```

Then --setup the code to grab all .md files in the _posts directory

```{r}
# avoid strings becoming factors
options(stringsAsFactors = FALSE)

# helper functions --------------------------------------------------------
generate_author_df <- function(file) {
  # extract "authors" field from yaml frontmatter
  # args:
  #   - file (string) a path to a markdown file with yaml frontmatter
  # returns:
  #   - data frame with a name and slug column, one row per author
  
  first_n_lines <- read_lines(file, n_max = 10) # should contain frontmatter
  author_line <- first_n_lines[grep("authors:", first_n_lines)]
  
  if (is.na(author_line[1])) {
    warning(paste("no authors for", file))
    return(data.frame(name = NULL, slug = NULL))
  }
  
  # remove "authors: " and square brackets
  author_line <- gsub(pattern = "authors: ", x = author_line, replacement = "" )
  author_line <- gsub(pattern = "\\]|\\[", x = author_line, replacement = "" )
  
  # make a data frame with a row for each author
  df <- author_line %>%
    strsplit(split = ",") %>%
    unlist() %>%
    data.frame() 
  names(df) <- "name"
  
  # remove spaces and make lowercase: "Matt Oakley -> matt-oakley
  df %>%
    mutate(name = trimws(name), 
           slug = tolower(gsub(pattern = " ", x = name, replacement = "-"))) 
}



# produce the authors.yaml file -----------------------------------------
post_dir <- "_posts"
md_files <- post_dir %>%
  file.path(list.files(post_dir, pattern = ".md", 
                           recursive = TRUE, include.dirs = TRUE))

# find all unique authors in the markdown files
authors <- lapply(md_files, generate_author_df) %>%
  do.call(what = rbind) %>%
  unique() %>%
  arrange(slug) 

finalYAML <- yaml::as.yaml(authors, column.major = FALSE)

# save output (do we need to prepend "_data/"?)
cat(finalYAML, file = "authors.yml")
```


